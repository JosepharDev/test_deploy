<!DOCTYPE html>
<html>
<head>
    <title>Wheat Health Monitoring</title>
    <!-- All previous head content remains the same -->
</head>
<body>
    <!-- All previous HTML content remains the same until the script section -->
    
    <script>
        // Initialize all chart variables
        let healthChart = null;
        let vegetationIndicesChart = null;
        let growthStageChart = null;
        let spectralReflectanceChart = null;

        // Previous map initialization code remains the same...

        // Modified displayResults function
        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            const prediction = data.prediction;
            const bandValues = data.band_data.area_values;
            const bandInfo = data.band_data.band_info;
            
            // Update prediction result display
            const resultDiv = document.getElementById('prediction-result');
            resultDiv.className = prediction.prediction === 1 ? 'health-status healthy' : 'health-status unhealthy';
            resultDiv.innerHTML = `
                <h3 style="margin-top: 0;">${prediction.prediction === 1 ? 'Healthy' : 'Unhealthy'} Wheat Field</h3>
                <p><strong>Confidence:</strong> ${(prediction.confidence * 100).toFixed(2)}%</p>
                <p><strong>Healthy Probability:</strong> ${(prediction.probabilities.healthy * 100).toFixed(2)}%</p>
                <p><strong>Unhealthy Probability:</strong> ${(prediction.probabilities.unhealthy * 100).toFixed(2)}%</p>
            `;
            
            // Destroy existing charts if they exist
            if (healthChart) healthChart.destroy();
            if (vegetationIndicesChart) vegetationIndicesChart.destroy();
            if (growthStageChart) growthStageChart.destroy();
            
            // Create new charts
            healthChart = createMiniChart(
                'health-chart',
                'doughnut',
                ['Healthy', 'Unhealthy'],
                [prediction.probabilities.healthy * 100, prediction.probabilities.unhealthy * 100],
                ['#4CAF50', '#F44336'],
                'Health Probability'
            );
            
            const vegetationIndices = ['NDVI', 'GNDVI', 'NPCI', 'DWSI', 'RVSI'];
            vegetationIndicesChart = createMiniChart(
                'vegetation-indices-chart',
                'bar',
                vegetationIndices,
                vegetationIndices.map(index => bandValues[index] || 0),
                '#2196F3',
                'Vegetation Indices'
            );

            growthStageChart = createGrowthStageChart(data);
            
            // Set up index selector change handler
            document.getElementById('index-select').addEventListener('change', function() {
                if (growthStageChart) growthStageChart.destroy();
                growthStageChart = updateGrowthStageChart(data, this.value);
            });
            
            // Rest of your table creation code remains the same...
        }

        // Modified chart creation functions to return chart instances
        function createMiniChart(canvasId, type, labels, data, color, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const backgroundColors = Array.isArray(color) ? color : 
                (type === 'line' || type === 'radar') ? 
                    [color] : 
                    new Array(data.length).fill(color);
            
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: type === 'line' ? color : undefined,
                        borderWidth: type === 'bar' ? 1 : 2,
                        fill: type !== 'bar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 12 }
                        },
                        legend: {
                            display: type === 'doughnut',
                            position: 'bottom'
                        },
                        datalabels: {
                            display: type === 'doughnut',
                            formatter: (value) => value > 5 ? value.toFixed(1) + '%' : ''
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: type !== 'line',
                            ticks: {
                                callback: (value) => type === 'doughnut' ? `${value}%` : value
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function createGrowthStageChart(data) {
            const ctx = document.getElementById('growth-stage-chart').getContext('2d');
            const selectedIndex = document.getElementById('index-select').value;
            const chartData = growthStageData[selectedIndex] || growthStageData['DWSI'];
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Dec. 15', 'Jan', 'Feb', 'March', 'April', 'May'],
                    datasets: [{
                        label: selectedIndex,
                        data: chartData,
                        borderColor: '#3f51b5',
                        backgroundColor: 'rgba(63, 81, 181, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#3f51b5',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Crop Growth Stage Monitoring',
                            font: { size: 14 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    const stages = ['Tillering', 'Stem Elongation', 'Heading', 'Grain Filling', 'Harvest'];
                                    return stages[context[0].dataIndex] || 'Growth Stage';
                                },
                                label: (context) => {
                                    return `${selectedIndex}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Index Value',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: Math.max(...chartData) * 1.2
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Growth Stage Timeline',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateGrowthStageChart(data, index) {
            const ctx = document.getElementById('growth-stage-chart').getContext('2d');
            const chartData = growthStageData[index] || growthStageData['DWSI'];
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Dec. 15', 'Jan', 'Feb', 'March', 'April', 'May'],
                    datasets: [{
                        label: index,
                        data: chartData,
                        borderColor: '#3f51b5',
                        backgroundColor: 'rgba(63, 81, 181, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#3f51b5',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Crop Growth Stage Monitoring',
                            font: { size: 14 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    const stages = ['Tillering', 'Stem Elongation', 'Heading', 'Grain Filling', 'Harvest'];
                                    return stages[context[0].dataIndex] || 'Growth Stage';
                                },
                                label: (context) => {
                                    return `${index}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Index Value',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: Math.max(...chartData) * 1.2
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Growth Stage Timeline',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Rest of your code remains the same...
    </script>
</body>
</html>